var notes = [
    {id: '1', note: 'A0', url: '/assets/keys/A0.mp3' },
    {id: '2', note: 'A#0', url: '/assets/keys/Bb0.mp3' },
    {id: '3', note: 'B0', url: '/assets/keys/B0.mp3' },
    {id: '4', note: 'C1', url: '/assets/keys/C1.mp3' },
    {id: '5', note: 'C#1', url: '/assets/keys/Db1.mp3' },
    {id: '6', note: 'D1', url: '/assets/keys/D1.mp3' },
    {id: '7', note: 'D#1', url: '/assets/keys/Eb1.mp3' },
    {id: '8', note: 'E1', url: '/assets/keys/E1.mp3' },
    {id: '9', note: 'F1', url: '/assets/keys/F1.mp3' },
    {id: '10', note: 'F#1', url: '/assets/keys/Gb1.mp3' },
    {id: '11', note: 'G1', url: '/assets/keys/G1.mp3' },
    {id: '12', note: 'G#1', url: '/assets/keys/Ab1.mp3' },
    {id: '13', note: 'A1', url: '/assets/keys/A1.mp3' },
    {id: '14', note: 'A#1', url: '/assets/keys/Bb1.mp3' },
    {id: '15', note: 'B1', url: '/assets/keys/B1.mp3' },
    {id: '16', note: 'C2', url: '/assets/keys/C2.mp3' },
    {id: '17', note: 'C#2', url: '/assets/keys/Db2.mp3' },
    {id: '18', note: 'D2', url: '/assets/keys/D2.mp3' },
    {id: '19', note: 'D#2', url: '/assets/keys/Eb2.mp3' },
    {id: '20', note: 'E2', url: '/assets/keys/E2.mp3' },
    {id: '21', note: 'F2', url: '/assets/keys/F2.mp3' },
    {id: '22', note: 'F#2', url: '/assets/keys/Gb2.mp3' },
    {id: '23', note: 'G2', url: '/assets/keys/G2.mp3' },
    {id: '24', note: 'G#2', url: '/assets/keys/Ab2.mp3' },
    {id: '25', note: 'A2', url: '/assets/keys/A2.mp3' },
    {id: '26', note: 'A#2', url: '/assets/keys/Bb2.mp3' },
    {id: '27', note: 'B2', url: '/assets/keys/B2.mp3' },
    {id: '28', note: 'C3', url: '/assets/keys/C3.mp3' },
    {id: '29', note: 'C#3', url: '/assets/keys/Db3.mp3' },
    {id: '30', note: 'D3', url: '/assets/keys/D3.mp3' },
    {id: '31', note: 'D#3', url: '/assets/keys/Eb3.mp3' },
    {id: '32', note: 'E3', url: '/assets/keys/E3.mp3' },
    {id: '33', note: 'F3', url: '/assets/keys/F3.mp3' },
    {id: '34', note: 'F#3', url: '/assets/keys/Gb3.mp3' },
    {id: '35', note: 'G3', url: '/assets/keys/G3.mp3' },
    {id: '36', note: 'G#3', url: '/assets/keys/Ab3.mp3' },
    {id: '37', note: 'A3', url: '/assets/keys/A3.mp3' },
    {id: '38', note: 'A#3', url: '/assets/keys/Bb3.mp3' },
    {id: '39', note: 'B3', url: '/assets/keys/B3.mp3' },
    {id: '40', note: 'C4', url: '/assets/keys/C4.mp3' },
    {id: '41', note: 'C#4', url: '/assets/keys/Db4.mp3' },
    {id: '42', note: 'D4', url: '/assets/keys/D4.mp3' },
    {id: '43', note: 'D#4', url: '/assets/keys/Eb4.mp3' },
    {id: '44', note: 'E4', url: '/assets/keys/E4.mp3' },
    {id: '45', note: 'F4', url: '/assets/keys/F4.mp3' },
    {id: '46', note: 'F#4', url: '/assets/keys/Gb4.mp3' },
    {id: '47', note: 'G4', url: '/assets/keys/G4.mp3' },
    {id: '48', note: 'G#4', url: '/assets/keys/Ab4.mp3' },
    {id: '49', note: 'A4', url: '/assets/keys/A4.mp3' },
    {id: '50', note: 'A#4', url: '/assets/keys/Bb4.mp3' },
    {id: '51', note: 'B4', url: '/assets/keys/B4.mp3' },
    {id: '52', note: 'C5', url: '/assets/keys/C5.mp3' },
    {id: '53', note: 'C#5', url: '/assets/keys/Db5.mp3' },
    {id: '54', note: 'D5', url: '/assets/keys/D5.mp3' },
    {id: '55', note: 'D#5', url: '/assets/keys/Eb5.mp3' },
    {id: '56', note: 'E5', url: '/assets/keys/E5.mp3' },
    {id: '57', note: 'F5', url: '/assets/keys/F5.mp3' },
    {id: '58', note: 'F#5', url: '/assets/keys/Gb5.mp3' },
    {id: '59', note: 'G5', url: '/assets/keys/G5.mp3' },
    {id: '60', note: 'G#5', url: '/assets/keys/Ab5.mp3' },
    {id: '61', note: 'A5', url: '/assets/keys/A5.mp3' },
    {id: '62', note: 'A#5', url: '/assets/keys/Bb5.mp3' },
    {id: '63', note: 'B5', url: '/assets/keys/B5.mp3' },
    {id: '64', note: 'C6', url: '/assets/keys/C6.mp3' },
    {id: '65', note: 'C#6', url: '/assets/keys/Db6.mp3' },
    {id: '66', note: 'D6', url: '/assets/keys/D6.mp3' },
    {id: '67', note: 'D#6', url: '/assets/keys/Eb6.mp3' },
    {id: '68', note: 'E6', url: '/assets/keys/E6.mp3' },
    {id: '69', note: 'F6', url: '/assets/keys/F6.mp3' },
    {id: '70', note: 'F#6', url: '/assets/keys/Gb6.mp3' },
    {id: '71', note: 'G6', url: '/assets/keys/G6.mp3' },
    {id: '72', note: 'G#6', url: '/assets/keys/Ab6.mp3' },
    {id: '73', note: 'A6', url: '/assets/keys/A6.mp3' },
    {id: '74', note: 'A#6', url: '/assets/keys/Bb6.mp3' },
    {id: '75', note: 'B6', url: '/assets/keys/B6.mp3' },
    {id: '76', note: 'C7', url: '/assets/keys/C7.mp3' },
    {id: '77', note: 'C#7', url: '/assets/keys/Db7.mp3' },
    {id: '78', note: 'D7', url: '/assets/keys/D7.mp3' },
    {id: '79', note: 'D#7', url: '/assets/keys/Eb7.mp3' },
    {id: '80', note: 'E7', url: '/assets/keys/E7.mp3' },
    {id: '81', note: 'F7', url: '/assets/keys/F7.mp3' },
    {id: '82', note: 'F#7', url: '/assets/keys/Gb7.mp3' },
    {id: '83', note: 'G7', url: '/assets/keys/G7.mp3' },
    {id: '84', note: 'G#7', url: '/assets/keys/Ab7.mp3' },
    {id: '85', note: 'A7', url: '/assets/keys/A7.mp3' },
    {id: '86', note: 'A#7', url: '/assets/keys/Bb7.mp3' },
    {id: '87', note: 'B7', url: '/assets/keys/B7.mp3' },
    {id: '88', note: 'C8', url: '/assets/keys/C8.mp3' }
];

const chords = [
    {id: '1', name: 'A-flat major', key: 'G# major', url: '/assets/chords/a-flat-major-chord.mp3', chord_notes: ['G#', 'C', 'D#']},
    {id: '2', name: 'A-flat minor', key: 'G# minor', url: '/assets/chords/a-flat-minor-chord.mp3', chord_notes: ['G#', 'B', 'D#']},
    {id: '3', name: 'A major', key: 'A major', url: '/assets/chords/a-major-chord.mp3', chord_notes: ['A', 'C#', 'E']},
    {id: '4', name: 'A minor', key: 'A minor', url: '/assets/chords/a-minor-chord.mp3', chord_notes: ['A', 'C', 'E']},
    {id: '5', name: 'A-sharp major', key: 'A# major', url: '/assets/chords/a-sharp-major-chord.mp3', chord_notes: ['A#', 'C##', 'F']},
    {id: '6', name: 'A-sharp minor', key: 'A# minor', url: '/assets/chords/a-sharp-minor-chord.mp3', chord_notes: ['A#', 'C#', 'F']},
    {id: '7', name: 'B-flat major', key: 'A# major', url: '/assets/chords/b-flat-major-chord.mp3', chord_notes: ['A#', 'D', 'F']},
    {id: '8', name: 'B-flat minor', key: 'A# minor', url: '/assets/chords/b-flat-minor-chord.mp3', chord_notes: ['A#', 'C#', 'F']},
    {id: '9', name: 'B major', key: 'B major', url: '/assets/chords/b-major-chord.mp3', chord_notes: ['B', 'D#', 'F#']},
    {id: '10', name: 'B minor', key: 'B minor', url: '/assets/chords/b-minor-chord.mp3', chord_notes: ['B', 'D', 'F#']},
    {id: '11', name: 'C-flat major', key: 'B major', url: '/assets/chords/c-flat-major-chord.mp3', chord_notes: ['B', 'D#', 'F#']},
    {id: '12', name: 'C-flat minor', key: 'B minor', url: '/assets/chords/c-flat-minor-chord.mp3', chord_notes: ['B', 'D##', 'F#']},
    {id: '13', name: 'C major', key: 'C major', url: '/assets/chords/c-major-chord.mp3', chord_notes: ['C', 'E', 'G']},
    {id: '14', name: 'C minor', key: 'C minor', url: '/assets/chords/c-minor-chord.mp3', chord_notes: ['C', 'D#', 'G']},
    {id: '15', name: 'C-sharp major', key: 'C# major', url: '/assets/chords/c-sharp-major-chord.mp3', chord_notes: ['C#', 'F', 'G#']},
    {id: '16', name: 'C-sharp minor', key: 'C# minor', url: '/assets/chords/c-sharp-minor-chord.mp3', chord_notes: ['C#', 'E', 'G#']},
    {id: '17', name: 'D-flat major', key: 'C# major', url: '/assets/chords/d-flat-major-chord.mp3', chord_notes: ['C#', 'F', 'G#']},
    {id: '18', name: 'D-flat minor', key: 'C# minor', url: '/assets/chords/d-flat-minor-chord.mp3', chord_notes: ['C#', 'E', 'G#']},
    {id: '19', name: 'D major', key: 'D major', url: '/assets/chords/d-major-chord.mp3', chord_notes: ['D', 'F#', 'A']},
    {id: '20', name: 'D minor', key: 'D minor', url: '/assets/chords/d-minor-chord.mp3', chord_notes: ['D', 'F', 'A']},
    {id: '21', name: 'D-sharp-major', key: 'D#', url: '/assets/chords/d-sharp-major-chord.mp3', chord_notes: ['D#', 'F##', 'A#']},
    {id: '22', name: 'D-sharp-major', key: 'D#', url: '/assets/chords/d-sharp-minor-chord.mp3', chord_notes: ['D#', 'F#', 'A#']},
    {id: '23', name: 'E-flat major', key: 'D# major', url: '/assets/chords/e-flat-minor-chord.mp3', chord_notes: ['D#', 'G', 'A#']},
    {id: '24', name: 'E-flat minor', key: 'E-flat minor', url: '/assets/chords/e-flat-minor-chord.mp3', chord_notes: ['D#', 'F#', 'A#']},
    {id: '25', name: 'E major', key: 'E major', url: '/assets/chords/e-major-chord.mp3', chord_notes: ['E', 'G#', 'B']},
    {id: '26', name: 'E minor', key: 'E minor', url: '/assets/chords/e-minor-chord.mp3', chord_notes: ['E', 'G', 'B']},
    {id: '27', name: 'F-flat major', key: 'E major', url: '/assets/chords/f-flat-major-chord.mp3', chord_notes: ['E', 'G#', 'B']},
    {id: '28', name: 'F-flat minor', key: 'E minor', url: '/assets/chords/f-flat-minor-chord.mp3', chord_notes: ['E', 'G##', 'B']},
    {id: '29', name: 'F major', key: 'F major', url: '/assets/chords/f-major-chord.mp3', chord_notes: ['F', 'A', 'C']},
    {id: '30', name: 'F minor', key: 'F minor', url: '/assets/chords/f-minor-chord.mp3', chord_notes: ['F', 'G#', 'C']},
    {id: '31', name: 'F-sharp major', key: 'F-sharp major', url: '/assets/chords/f-sharp-major-chord.mp3', chord_notes: ['F#', 'A#', 'C#']},
    {id: '32', name: 'F-sharp minor', key: 'F-sharp minor', url: '/assets/chords/f-sharp-minor-chord.mp3', chord_notes: ['F#', 'A', 'C#']},
    {id: '33', name: 'G-flat major', key: 'F# major', url: '/assets/chords/g-flat-major-chord.mp3', chord_notes: ['F#', 'A#', 'C#']},
    {id: '34', name: 'G-flat minor', key: 'F# minor', url: '/assets/chords/g-flat-minor-chord.mp3', chord_notes: ['F#', 'A##', 'C#']},
    {id: '35', name: 'G major', key: 'G major', url: '/assets/chords/g-major-chord.mp3', chord_notes: ['G', 'B', 'D']},
    {id: '36', name: 'G minor', key: 'G minor', url: '/assets/chords/g-minor-chord.mp3', chord_notes: ['G', 'A#', 'D']},
    {id: '37', name: 'G-sharp major', key: 'G# major', url: '/assets/chords/g-sharp-major-chord.mp3', chord_notes: ['G#', 'C', 'D#']},
    {id: '38', name: 'G-sharp minor', key: 'G# minor', url: '/assets/chords/g-sharp-minor-chord.mp3', chord_notes: ['G#', 'B', 'D#']}
  ];

const chord_progressions = [
    {
        name: 'A-flat major',
        chords: [
            {name: 'A-flat major', url: chords[0].url, chord_notes: chords[0].chord_notes },
            {name: 'B-flat major', url: chords[6].url, chord_notes: chords[6].chord_notes }, 
            {name: 'C minor', url: chords[13].url, chord_notes: chords[13].chord_notes }, 
            {name: 'D-flat major', url: chords[16].url, chord_notes: chords[16].chord_notes }, 
            {name: 'E-flat major', url: chords[26].url, chord_notes: chords[26].chord_notes }, 
            {name: 'F minor', url: chords[29].url, chord_notes: chords[29].chord_notes }
        ],
    },
    {
        name: 'C major',
        chords: [
            {name: 'C major', url: chords[12].url, chord_notes: chords[12].chord_notes}, 
            {name: 'D minor', url: chords[19].url, chord_notes: chords[19].chord_notes}, 
            {name: 'E minor', url: chords[25].url, chord_notes: chords[25].chord_notes}, 
            {name: 'F major', url: chords[28].url, chord_notes: chords[28].chord_notes}, 
            {name: 'G major', url: chords[34].url, chord_notes: chords[34].chord_notes}, 
            {name: 'A minor', url: chords[3].url, chord_notes: chords[3].chord_notes}
        ],
    },    
    // {
    //     name: '',
    //     chords: [],
    // },

];

let beats_per_minute = 100;
let time_signature_1 = 4;
let time_signature_2 = 4;

const note_note = [];
const note_url = [];

for (let j = 0; j < notes.length; j++) {
    const element = notes[j];
    note_note.push(element.note);
    note_url.push(element.url);
}
console.log(note_note, note_url);
let randomKeys = _.sample(note_note);
console.log(randomKeys);


console.log(notes, chords);

const chord_name = [];
const chord_key = [];
const chord_url = [];
const chord_notes = [];

for (let j = 0; j < chords.length; j++) {
    const element = chords[j];
    chord_name.push(element.name);
    chord_key.push(element.key);
    chord_url.push(element.url);
    for (let i = 0; i < element.chord_notes.length; i++) {
        const elements = element.chord_notes[i];
        chord_notes.push(elements);
    } 
}
console.log(chord_name, chord_key, chord_url, chord_notes);

let currentAudio = null;

async function volAudio(audioSrc) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
    }
    const audio = await new Audio(audioSrc);
    currentAudio = audio;
    audio.volume = 0.3;
    let loopCount = 0;
    const maxLoops = 4; // Change this to the desired number of loops
    audio.addEventListener('ended', function () {
      loopCount++;
      if (loopCount < maxLoops) {
        this.currentTime = 0; // Reset the audio to the beginning
        this.play(); // Play again
      }
    });
    // Play the audio
    audio.play();
}

async function playAudio(audioSrc) {
    const audio = await new Audio(audioSrc);
    let loopCount = 0;
    const maxLoops = 6; // Change this to the desired number of loops
    audio.addEventListener('ended', function () {
      loopCount++;
      if (loopCount < maxLoops) {
        this.currentTime = 0; // Reset the audio to the beginning
        this.play(); // Play again
      }
    });
    // Play the audio
    audio.play();
}


function getRandomElement(array) {
    const randomIndex = Math.floor(Math.random() * array.length);
    return array[randomIndex];
}

let octave_1 = 1;
let octave_2 = 2;
let octave_3 = 3;
let octave_4 = 4;
let octave_5 = 5;
let octave_6 = 6;
let octave_7 = 7;
let octave_8 = 8;

function gen_song() {
   $(document).ready(() => {     
    
  $('[id="generate-music"]').on("click", function(e) {
    currentAudio

    e.preventDefault();

    const numberOfChords = 1;
    for (let i = 0; i < numberOfChords; i++) {
        
let write_to_div = document.getElementById('piano-notes');

if (notes && chords !== undefined) {
    if (Math.random() < 0.1) {
        // // Play a single note
        // const randomNote = getRandomElement(note_url);
        // const randomTiming = 5000; // Adjust the timing range as needed
        // setTimeout(() => playAudio(randomNote), randomTiming);
        // const res = notes.find(x => x.url ===  randomNote);
        // console.log(randomNote, res);
    } else {
        // Play a chord
        const randomChord = getRandomElement(chord_url);
        
        

        const res = chords.find(x => x.url ===  randomChord);
        const res_keys = Object.values(res.chord_notes);

        const chord_progress_res = chord_progressions.find(x => x.name ===  res.name);
        const chordProgress = chord_progressions;
        console.log("Chord Progresses ", chordProgress);

chord_progressions.forEach(element => {
    if (res.name == element.name) {

        
        alert("Chord Progress");
        console.log("Chord Progress xxxxxxxx ", element.name);
        console.log("Further Chords xxxxxxxx ", element.chords[0]);




    

    const randomTiming = Math.floor((Math.random() * 10000) + 1000);
    console.log("ooooooooooooo ", randomTiming);
    const keyTiming = Math.floor(Math.random() * randomTiming / 2);
        
        // const playTimeout = setTimeout(() => {
        //     volAudio(randomChord)
        // }, randomTiming);
        // function playStopFunction() {
        //     clearTimeout(playTimeout);
        // }
        // playStopFunction();

for (let i = 0; i < element.chords.length; i++) {
    const element_chords = element.chords[i];
    const randomTimingMath = Math.round(randomTiming * [i]);
    // console.log("Progression Chord zzzzzzzz ", element_chords.url, randomTimingMath);

    const audioQueue = element.chords
  
      let currentAudioIndex = 0;
      const audioElement = document.getElementById('audio');
  
      function playNextAudio() {
        if (currentAudioIndex < audioQueue.length) {
          const audioSrc = audioQueue.id;
          audioElement.src = audioSrc;
          audioElement.play();
          currentAudioIndex++;
        }
      }
  
      function startAudioQueue() {
        // Reset the index to the beginning
        currentAudioIndex = 0;
  
        // Attach an event listener to play the next audio when the current one ends
        audioElement.addEventListener('ended', playNextAudio);
  
        // Start playing the first audio
        playNextAudio();
      }

      startAudioQueue()
      
    function progressChords(chords) {
        setTimeout(() => {
            volAudio(element_chords.url)
        },  Math.round(randomTimingMath) + 2000);
    }
    setInterval(progressChords, Math.round(randomTimingMath) * [i] + 10000);

    const get_chord_progress_notes = element_chords.chord_notes;
    const get_chord_progress_url = element_chords.url;
    console.log("Progression Chord Notes vvvvvvvvvv ", get_chord_progress_notes, get_chord_progress_url,  Math.round(randomTimingMath) + 2000);

    
    // for (let f = 0; f < get_chord_progress_notes.length; f++) {
    //     const key_element = get_chord_progress_notes[f];
    //     if (key_element.includes("##")) {
    //         const transpose_key = key_element.replace(/##/g, '#');
    //         const get_key = notes.find(x => x.note === transpose_key+octave_3); 
    //         setTimeout(() => {
    //             playAudio(get_key.url)
    //         }, keyTiming);
    //     } else {
    //         const get_key = notes.find(x => x.note === key_element+octave_3);
    //         setTimeout(() => {
    //             playAudio(get_key.url)
    //         }, keyTiming);
    //     }
    //     console.log("Progression Chord Notes rrrrrrrrr ", key_element);
    // }

}        

// for (let j = 0; j < res_keys.length; j++) {
//     const element_key = res_keys[j];
//     if (element_key.includes("##")) {
//         const transpose_key = element_key.replace(/##/g, '#');
//         const get_key = notes.find(x => x.note === transpose_key+octave_2);
//         setTimeout(() => {
//             playAudio(get_key.url)
//         }, keyTiming);
//         console.log("Chord Key ", [j], " pppppppp ", get_key.note, get_key.url, keyTiming * [j] * 1.5); 
//     } else {
//         const get_key = notes.find(x => x.note === element_key+octave_3);
//         setTimeout(() => {
//             playAudio(get_key.url)
//         }, keyTiming);
        
//         console.log("Chord Key ", [j], " pppppppp ", get_key.note, get_key.url, keyTiming * [j] * 1.5);  
//     }
// }

console.log("Random Chord Timing xxxxxxxx ", randomTiming);
        console.log("Random Chord URL xxxxxxxx ", randomChord);
        console.log("Random Chord Search xxxxxxxx ", res);
        console.log("Random Chord Keys xxxxxxxx ", res_keys);


        write_to_div.insertAdjacentHTML(
            'afterBegin', 
            `<h1>` + res.name + ` <small class="fs-6">keys(` + res_keys + `)</small></h1>`
        );
        // write_to_div.innerHTML += `<h1>` + res.name + `</h1>`;




    }  
});



        



      } 
}


    }
});
})
}

  
  
function playNotess() {
for (let i = 0; i < randomNotes.length; i++) {
    const element = randomNotes[i].key;
    playNote(element);
    console.log(element);
}    
}






















function randomPianoGenerator() {
    const element = (
    <div>
        
        <article>
  <aside id="aside"></aside>
  <div id="piano-container"></div>
</article>
   
        <div id="piano">
            {/* <div id="generate-music" className="piano-key btn btn-primary btn-lg">Generate piano</div> */}
            <div id="piano-notes" className="mt-4"></div>

            <audio id="audio" className="audio"></audio>


        </div>

    </div>
    );
    ReactDOM.render(
        element,
        document.getElementById('random_piano_generator_component')
    );
}

randomPianoGenerator();
gen_song();


  
async function piano_player() {
    



// console.clear();
document.documentElement.addEventListener("mousedown", () => {
    if (Tone.context.state !== "running") Tone.context.resume();
  });
  /**
   * MusicalScale
   * generate a scale of music
   * https://codepen.io/jakealbaugh/pen/NrdEYL/
   *
   * @param key {String} 
       the root of the key. flats will be converted to sharps.
         C, C#, D, D#, E, F, F#, G, G#, A, A#, B
   * @param mode {String} 
       desired mode.
         ionian, dorian, phrygian, lydian, mixolydian, aeolian, locrian, 
       can also pass in:
         major, minor, melodic, harmonic
   *
   * @return {Object}
       _scale: scale info
       key: the scale key
       mode: the scale mode id
       notes: an array of notes
         step: index of note in key
         note: the actual note
         rel_octave: 0 || 1, in root octave or next
         triad: major, minor, diminished, or augmented triad for this note
           interval: I, ii, etc
           type: min, maj, dim, aug
           notes: array of notes in the triad
             note: the note
             rel_octave: 0 || 1 || 2, relative to key root octave
   */
  
  class MusicalScale {
    constructor(params) {
      this.dict = this._loadDictionary();
      let errors = this._errors(params);
      if (errors) return;
      this.updateScale = this.pubUpdateScale;
  
      this._loadScale(params);
    }
  
    pubUpdateScale(params) {
      let errors = this._errors(params);
      if (errors) return;
      this._loadScale(params);
    }
  
    _loadScale(params) {
      // clean up the key param
      this.key = this._paramKey(params.key);
      // set the mode
      this.mode = params.mode;
      this.notes = [];
      this._scale = this.dict.scales[this._paramMode(this.mode)];
  
      // notes to cycle through
      let keys = this.dict.keys;
      // starting index for key loop
      let offset = keys.indexOf(this.key);
      for (let s = 0; s < this._scale.steps.length; s++) {
        let step = this._scale.steps[s];
        let idx = (offset + step) % keys.length;
        // relative octave. 0 = same as root, 1 = next ocave up
        let rel_octave = offset + step > keys.length - 1 ? 1 : 0;
        // generate the relative triads
        let triad = this._genTriad(s, idx, rel_octave, this._scale.triads[s]);
        // define the note
        let note = {
          step: s,
          note: keys[idx],
          rel_octave: rel_octave,
          triad: triad
        };
        // add the note
        this.notes.push(note);
      }
    }
  
    // create a chord of notes based on chord type
    _genTriad(s, offset, octave, t) {
      // get the steps for this chord type
      let steps = this.dict.triads[t];
      // instantiate the chord
      let chord = { type: t, interval: this._intervalFromType(s, t), notes: [] };
      // load the notes
      let keys = this.dict.keys;
      for (let i = 0; i < steps.length; i++) {
        let step = steps[i];
        let idx = (offset + step) % keys.length;
        // relative octave to base
        let rel_octave = offset + step > keys.length - 1 ? octave + 1 : octave;
        // define the note
        chord.notes.push({ note: keys[idx], rel_octave: rel_octave });
      }
      return chord;
    }
  
    // proper interval notation from the step and type
    _intervalFromType(step, type) {
      let steps = "i ii iii iv v vi vii".split(" ");
      let s = steps[step];
      switch (type) {
        case "maj":
          s = s.toUpperCase();
          break;
        case "min":
          s = s;
          break;
        case "aug":
          s = s.toUpperCase() + "+";
          break;
        case "dim":
          s = s + "°";
          break;
      }
      return s;
    }
  
    _errors(params) {
      if (this.dict.keys.indexOf(params.key) === -1) {
        if (Object.keys(this.dict.flat_sharp).indexOf(params.key) === -1) {
          return console.error(
            `${params.key} is an invalid key. ${this.dict.keys.join(", ")}`
          );
        }
      } else if (this.dict.modes.indexOf(params.mode) === -1) {
        return console.error(
          `${params.mode} is an invalid mode. ${this.dict.modes.join(", ")}`
        );
      } else {
        return false;
      }
    }
  
    _loadDictionary() {
      return {
        keys: "C C# D D# E F F# G G# A A# B".split(" "),
        scales: {
          ion: {
            name: "Ionian",
            steps: this._genSteps("W W H W W W H"),
            dominance: [3, 0, 1, 0, 2, 0, 1],
            triads: this._genTriads(0)
          },
          dor: {
            name: "Dorian",
            steps: this._genSteps("W H W W W H W"),
            dominance: [3, 0, 1, 0, 2, 2, 1],
            triads: this._genTriads(1)
          },
          phr: {
            name: "Phrygian",
            steps: this._genSteps("H W W W H W W"),
            dominance: [3, 2, 1, 0, 2, 0, 1],
            triads: this._genTriads(2)
          },
          lyd: {
            name: "Lydian",
            steps: this._genSteps("W W W H W W H"),
            dominance: [3, 0, 1, 2, 2, 0, 1],
            triads: this._genTriads(3)
          },
          mix: {
            name: "Mixolydian",
            steps: this._genSteps("W W H W W H W"),
            dominance: [3, 0, 1, 0, 2, 0, 2],
            triads: this._genTriads(4)
          },
          aeo: {
            name: "Aeolian",
            steps: this._genSteps("W H W W H W W"),
            dominance: [3, 0, 1, 0, 2, 0, 1],
            triads: this._genTriads(5)
          },
          loc: {
            name: "Locrian",
            steps: this._genSteps("H W W H W W W"),
            dominance: [3, 0, 1, 0, 3, 0, 0],
            triads: this._genTriads(6)
          },
          mel: {
            name: "Melodic Minor",
            steps: this._genSteps("W H W W W W H"),
            dominance: [3, 0, 1, 0, 3, 0, 0],
            triads: "min min aug maj maj dim dim".split(" ")
          },
          har: {
            name: "Harmonic Minor",
            steps: this._genSteps("W H W W H WH H"),
            dominance: [3, 0, 1, 0, 3, 0, 0],
            triads: "min dim aug min maj maj dim".split(" ")
          }
        },
        modes: [
          "ionian",
          "dorian",
          "phrygian",
          "lydian",
          "mixolydian",
          "aeolian",
          "locrian",
          "major",
          "minor",
          "melodic",
          "harmonic"
        ],
        flat_sharp: {
          Cb: "B",
          Db: "C#",
          Eb: "D#",
          Fb: "E",
          Gb: "F#",
          Ab: "G#",
          Bb: "A#"
        },
        triads: {
          maj: [0, 4, 7],
          min: [0, 3, 7],
          dim: [0, 3, 6],
          aug: [0, 4, 8]
        }
      };
    }
  
    _paramMode(mode) {
      return {
        minor: "aeo",
        major: "ion",
        ionian: "ion",
        dorian: "dor",
        phrygian: "phr",
        lydian: "lyd",
        mixolydian: "mix",
        aeolian: "aeo",
        locrian: "loc",
        melodic: "mel",
        harmonic: "har"
      }[mode];
    }
  
    _paramKey(key) {
      if (this.dict.flat_sharp[key]) return this.dict.flat_sharp[key];
      return key;
    }
  
    _genTriads(offset) {
      // this is ionian, each mode bumps up one offset.
      let base = "maj min min maj maj min dim".split(" ");
      let triads = [];
      for (let i = 0; i < base.length; i++) {
        triads.push(base[(i + offset) % base.length]);
      }
      return triads;
    }
  
    _genSteps(steps_str) {
      let arr = steps_str.split(" ");
      let steps = [0];
      let step = 0;
      for (let i = 0; i < arr.length - 1; i++) {
        let inc = 0;
        switch (arr[i]) {
          case "W":
            inc = 2;
            break;
          case "H":
            inc = 1;
            break;
          case "WH":
            inc = 3;
            break;
        }
        step += inc;
        steps.push(step);
      }
      return steps;
    }
  }
  
  /**
    ArpeggioPatterns
    https://codepen.io/jakealbaugh/pen/PzpzEO/
    returns arrays of arpeggio patterns for a given length of notes
    @param steps {Integer} number of steps
    @return {Object}
      patterns: {Array} of arpeggiated index patterns
   */
  
  class ArpeggioPatterns {
    constructor(params) {
      this.steps = params.steps;
      this._loadPatterns();
      this.updatePatterns = this.pubUpdatePatterns;
    }
  
    pubUpdatePatterns(params) {
      this.steps = params.steps;
      this._loadPatterns();
    }
  
    _loadPatterns() {
      this.arr = [];
      this.patterns = [];
      for (let i = 0; i < this.steps; i++) {
        this.arr.push(i);
      }
      this._used = [];
      this.permutations = this._permute(this.arr);
      this.looped = this._loop();
      this.patterns = {
        straight: this.permutations,
        looped: this.looped
      };
    }
  
    _permute(input, permutations) {
      permutations = permutations || [];
      var i, ch;
      for (i = 0; i < input.length; i++) {
        ch = input.splice(i, 1)[0];
        this._used.push(ch);
        if (input.length === 0) {
          permutations.push(this._used.slice());
        }
        this._permute(input, permutations);
        input.splice(i, 0, ch);
        this._used.pop();
      }
      return permutations;
    }
  
    _loop() {
      let looped = [];
      for (let p = 0; p < this.permutations.length; p++) {
        let perm = this.permutations[p];
        let arr = Array.from(perm);
        for (let x = 1; x < perm.length - 1; x++) {
          arr.push(perm[perm.length - 1 - x]);
        }
        looped.push(arr);
      }
      return looped;
    }
  }
  
  /**
    ArpPlayer
    the main app
   */
  
  class ArpPlayer {
    constructor(params) {
      this.container = document.querySelector("#piano-container");
      this.aside = document.querySelector("#aside");
      this.chords = [0, 2, 6, 3, 4, 2, 5, 1];
      this.ms_key = "G";
      this.ms_mode = "locrian";
      this.ap_steps = 6;
      this.ap_pattern_type = "straight"; // || 'looped'
      this.ap_pattern_id = 0;
      this.player = {
        chord_step: 0,
        octave_base: 4,
        arp_repeat: 2,
        bass_on: false,
        triad_step: 0,
        step: 0,
        playing: false,
        bpm: 135
      };
      this.chord_count = this.chords.length;
      this._setMusicalScale();
      this._setArpeggioPatterns();
      this._drawKeyboard();
      this._drawOutput();
      this._loadChordSelector();
      this._loadBPMSelector();
      this._loadKeySelector();
      this._loadModeSelector();
      this._loadStepsSelector();
      this._loadTypeSelector();
      this._loadPatternSelector();
      this._loadSynths();
      this._loadTransport();
  
      // change tabs, pause player
      document.addEventListener("visibilitychange", () => {
        this.player.playing = true;
        this.playerToggle();
      });
  
      console.log("eeeeeeeeeeeeeeeeeeeeeeeee   ", this.MS);
    }
  
    _loadSynths() {
      this.channel = {
        master: new Tone.Gain(0.7),
        treb: new Tone.Gain(0.7),
        bass: new Tone.Gain(0.8)
      };
      this.fx = {
        distortion: new Tone.Distortion(0.8),
        reverb: new Tone.Freeverb(0.1, 3000),
        delay: new Tone.PingPongDelay("16n", 0.1)
      };
      this.synths = {
        treb: new Tone.PolySynth(1, Tone.SimpleAM),
        bass: new Tone.DuoSynth()
      };
  
      this.synths.bass.vibratoAmount.value = 0.1;
      this.synths.bass.harmonicity.value = 1.5;
      this.synths.bass.voice0.oscillator.type = "triangle";
      this.synths.bass.voice0.envelope.attack = 0.05;
      this.synths.bass.voice1.oscillator.type = "triangle";
      this.synths.bass.voice1.envelope.attack = 0.05;
  
      // fx mixes
      this.fx.distortion.wet.value = 0.2;
      this.fx.reverb.wet.value = 0.2;
      this.fx.delay.wet.value = 0.3;
      // gain levels
      this.channel.master.toMaster();
      this.channel.treb.connect(this.channel.master);
      this.channel.bass.connect(this.channel.master);
      // fx chains
      this.synths.treb.chain(this.fx.delay, this.fx.reverb, this.channel.treb);
      this.synths.bass.chain(this.fx.distortion, this.channel.bass);
    }
  
    _loadTransport() {
      this.playerUpdateBPM = (e) => {
        let el = e.target;
        let bpm = el.getAttribute("data-value");
        this.player.bpm = parseInt(bpm);
        Tone.Transport.bpm.value = this.player.bpm;
        this._utilClassToggle(e.target, "bpm-current");
      };
  
      this.playerToggle = () => {
        if (this.player.playing) {
          Tone.Transport.pause();
          this.channel.master.gain.value = 0;
          this.play_toggle.classList.remove("active");
        } else {
          Tone.Transport.start();
          this.channel.master.gain.value = 1;
          this.play_toggle.classList.add("active");
        }
        this.player.playing = !this.player.playing;
      };
  
      this.play_toggle = document.createElement("button");
      this.play_toggle.innerHTML = `<span class="play">Play</span><span class="pause">Pause</span>`;
      this.aside.appendChild(this.play_toggle);
      this.play_toggle.addEventListener("touchstart", (e) => {
        Tone.startMobile();
      });
      this.play_toggle.addEventListener("click", (e) => {
        this.playerToggle();
      });
  
      Tone.Transport.bpm.value = this.player.bpm;
      Tone.Transport.scheduleRepeat((time) => {
        let curr_chord = this.player.chord_step % this.chord_count;
  
        let prev = document.querySelector(".chord > div.active");
        if (prev) prev.classList.remove("active");
        let curr = document.querySelector(
          `.chord > div:nth-of-type(${curr_chord + 1})`
        );
        if (curr) curr.classList.add("active");
  
        let chord = this.MS.notes[this.chords[curr_chord]];
  
        // finding the current note
        let notes = chord.triad.notes;
        for (let i = 0; i < Math.ceil(this.ap_steps / 3); i++) {
          notes = notes.concat(
            notes.map((n) => {
              return { note: n.note, rel_octave: n.rel_octave + (i + 1) };
            })
          );
        }
        let note = notes[this.arpeggio[this.player.step % this.arpeggio.length]];
  
        // setting bass notes
        let bass_o = chord.rel_octave + 2;
        let bass_1 = chord.note + bass_o;
  
        // slappin da bass
        if (!this.player.bass_on) {
          this.player.bass_on = true;
          this.synths.bass.triggerAttack(bass_1, time);
          this._utilActiveNoteClassToggle(
            [bass_1.replace("#", "is")],
            "active-b"
          );
        }
  
        // bump the step
        this.player.step++;
  
        // changing chords
        if (
          this.player.step % (this.arpeggio.length * this.player.arp_repeat) ===
          0
        ) {
          this.player.chord_step++;
          this.player.bass_on = false;
          this.synths.bass.triggerRelease(time);
          this.player.triad_step++;
        }
        // arpin'
        let note_ref = `${note.note}${note.rel_octave + this.player.octave_base}`;
        this._utilActiveNoteClassToggle(
          [note_ref.replace("#", "is")],
          "active-t"
        );
        this.synths.treb.triggerAttackRelease(note_ref, "16n", time);
      }, "16n");
    }
  
    _drawKeyboard() {
      let octaves = [2, 3, 4, 5, 6, 7];
      let keyboard = document.createElement("section");
      keyboard.classList.add("keyboard");
      this.container.appendChild(keyboard);
      octaves.forEach((octave) => {
        this.MS.dict.keys.forEach((key) => {
          let el = document.createElement("div");
          let classname = key.replace("#", "is") + octave;
          el.classList.add(classname);
          keyboard.appendChild(el);
        });
      });
    }
  
    _drawOutput() {
      this.output = document.createElement("section");
      this.output.classList.add("output");
      this.aside.appendChild(this.output);
      this._updateOutput();
    }
  
    _updateOutput() {
      this.output.innerHTML = "";
      let title = document.createElement("h1");
      title.innerHTML = "Output";
      this.output.appendChild(title);
      let description = document.createElement("h2");
      description.innerHTML = `${this.MS.key} ${this.MS._scale.name}`;
      this.output.appendChild(description);
      this.chords.forEach((chord) => {
        let note = this.MS.notes[chord];
        let el = document.createElement("span");
        el.innerHTML = `${note.note.replace("#", "<sup>♯</sup>")} <small>${
          note.triad.type
        }</small>`;
        this.output.appendChild(el);
      });
    }
  
    _loadBPMSelector() {
      let bpm_container = document.createElement("section");
      bpm_container.classList.add("bpm");
      this.aside.appendChild(bpm_container);
      let title = document.createElement("h1");
      title.innerHTML = "Beats Per Minute";
      bpm_container.appendChild(title);
  
      [45, 60, 75, 90, 105, 120, 135, 150].forEach((bpm) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", bpm);
        if (bpm === this.player.bpm) el.classList.add("bpm-current");
        el.innerHTML = bpm;
        el.addEventListener("click", (e) => {
          this.playerUpdateBPM(e);
        });
        bpm_container.appendChild(el);
      });
    }
  
    _loadChordSelector() {
      this.chord_container = document.createElement("section");
      this.chord_container.classList.add("chord");
      this.container.appendChild(this.chord_container);
      let title = document.createElement("h1");
      title.innerHTML = "Chord Progression";
      this.chord_container.appendChild(title);
  
      this.msUpdateChords = (e) => {
        let el = e.target;
        let chord = el.getAttribute("data-chord");
        let value = el.getAttribute("data-value");
        this.chords[parseInt(chord)] = value;
        this._utilClassToggle(e.target, `chord-${chord}-current`);
        this._updateOutput();
      };
  
      for (let c = 0; c < this.chord_count; c++) {
        let chord_el = document.createElement("div");
        this.MS.notes.forEach((note, i) => {
          let el = document.createElement("div");
          el.setAttribute("data-value", i);
          el.setAttribute("data-chord", c);
          if (i === this.chords[c]) el.classList.add(`chord-${c}-current`);
          el.innerHTML = "i ii iii iv v vi vii".split(" ")[i];
          el.addEventListener("click", (e) => {
            this.msUpdateChords(e);
          });
          chord_el.appendChild(el);
        });
        this.chord_container.appendChild(chord_el);
      }
  
      this._updateChords();
    }
  
    _updateChords() {
      this.MS.notes.forEach((note, i) => {
        let updates = document.querySelectorAll(
          `.chord div > div:nth-child(${i + 1})`
        );
        for (let u = 0; u < updates.length; u++) {
          updates[u].innerHTML = note.triad.interval;
        }
      });
    }
  
    _loadKeySelector() {
      let key_container = document.createElement("section");
      key_container.classList.add("keys");
      this.container.appendChild(key_container);
      let title = document.createElement("h1");
      title.innerHTML = "Tonic / Root";
      key_container.appendChild(title);
  
      this.MS.dict.keys.forEach((key) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", key);
        if (key === this.ms_key) el.classList.add("key-current");
        el.innerHTML = key;
        el.addEventListener("click", (e) => {
          this.msUpdateKey(e);
        });
        key_container.appendChild(el);
      });
    }
  
    _loadModeSelector() {
      let mode_container = document.createElement("section");
      mode_container.classList.add("modes");
      this.container.appendChild(mode_container);
      let title = document.createElement("h1");
      title.innerHTML = "Mode";
      mode_container.appendChild(title);
  
      this.MS.dict.modes.forEach((mode) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", mode);
        if (mode === this.ms_mode) el.classList.add("mode-current");
        el.innerHTML = mode;
        el.addEventListener("click", (e) => {
          this.msUpdateMode(e);
        });
        mode_container.appendChild(el);
      });
    }
  
    _loadTypeSelector() {
      let type_container = document.createElement("section");
      type_container.classList.add("type");
      this.container.appendChild(type_container);
      let title = document.createElement("h1");
      title.innerHTML = "Arpeggio Type";
      type_container.appendChild(title);
  
      ["straight", "looped"].forEach((step) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", step);
        if (step === this.ap_pattern_type) el.classList.add("type-current");
        el.innerHTML = step;
        el.addEventListener("click", (e) => {
          this.apUpdatePatternType(e);
        });
        type_container.appendChild(el);
      });
    }
  
    _loadStepsSelector() {
      let steps_container = document.createElement("section");
      steps_container.classList.add("steps");
      this.container.appendChild(steps_container);
      let title = document.createElement("h1");
      title.innerHTML = "Arpeggio Steps";
      steps_container.appendChild(title);
  
      [3, 4, 5, 6].forEach((step) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", step);
        if (step === this.ap_steps) el.classList.add("step-current");
        el.innerHTML = step;
        el.addEventListener("click", (e) => {
          this.apUpdateSteps(e);
        });
        steps_container.appendChild(el);
      });
    }
  
    _loadPatternSelector() {
      this.pattern_container = document.createElement("section");
      this.pattern_container.classList.add("patterns");
      this.container.appendChild(this.pattern_container);
      this._updatePatternSelector();
    }
  
    _updatePatternSelector() {
      this.pattern_container.innerHTML = "";
      // reset if the id is over
      this.ap_pattern_id =
        this.ap_pattern_id > this.AP.patterns[this.ap_pattern_type].length - 1
          ? 0
          : this.ap_pattern_id;
      this.arpeggio = this.AP.patterns[this.ap_pattern_type][this.ap_pattern_id];
      let title = document.createElement("h1");
      title.innerHTML = "Arpeggio Style";
      this.pattern_container.appendChild(title);
      let patterns = this.AP.patterns[this.ap_pattern_type];
      [720, 120, 24, 6].forEach((count) => {
        this.pattern_container.classList.remove(`patterns-${count}`);
      });
      this.pattern_container.classList.add(`patterns-${patterns.length}`);
      patterns.forEach((pattern, i) => {
        let el = document.createElement("div");
        el.setAttribute("data-value", i);
        if (i === this.ap_pattern_id) el.classList.add("id-current");
        el.innerHTML = pattern.join("");
        el.appendChild(this._genPatternSvg(pattern));
        el.addEventListener("click", (e) => {
          this.apUpdatePatternId(e);
        });
        this.pattern_container.appendChild(el);
      });
    }
  
    _genPatternSvg(pattern) {
      let hi = Array.from(pattern).sort()[pattern.length - 1];
      let spacing = 2;
      let svgns = "http://www.w3.org/2000/svg";
      let svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
      let width = pattern.length * spacing + spacing;
      let height = hi + spacing * 2;
      svg.setAttribute("height", height);
      svg.setAttribute("width", width);
      svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
      svg.setAttributeNS(
        "http://www.w3.org/2000/xmlns/",
        "xmlns:xlink",
        "http://www.w3.org/1999/xlink"
      );
      let polyline = document.createElementNS(svgns, "polyline");
      let points = [];
      let x = spacing;
      for (let i = 0; i < pattern.length; i++) {
        let y = height - pattern[i] - spacing;
        points.push(x + "," + y);
        x += spacing;
      }
      polyline.setAttribute("points", points.join(" "));
      svg.appendChild(polyline);
      return svg;
    }
  
    _setMusicalScale() {
      this.MS = new MusicalScale({ key: this.ms_key, mode: this.ms_mode });
      this.msUpdateKey = (e) => {
        this._utilClassToggle(e.target, "key-current");
        this.ms_key = e.target.getAttribute("data-value");
        this.msUpdateScale();
      };
      this.msUpdateMode = (e) => {
        this._utilClassToggle(e.target, "mode-current");
        this.ms_mode = e.target.getAttribute("data-value");
        this.msUpdateScale();
        this._updateChords();
      };
      this.msUpdateScale = () => {
        this.MS.updateScale({ key: this.ms_key, mode: this.ms_mode });
        this._updateOutput();
      };
    }
  
    _setArpeggioPatterns() {
      this.AP = new ArpeggioPatterns({ steps: this.ap_steps });
      this.apUpdateSteps = (e) => {
        this._utilClassToggle(e.target, "step-current");
        let steps = e.target.getAttribute("data-value");
        this.ap_steps = parseInt(steps);
        this.AP.updatePatterns({ steps: steps });
        this.apUpdate();
        this._updatePatternSelector();
      };
      this.apUpdatePatternType = (e) => {
        this._utilClassToggle(e.target, "type-current");
        this.ap_pattern_type = e.target.getAttribute("data-value");
        this.apUpdate();
        this._updatePatternSelector();
      };
      this.apUpdatePatternId = (e) => {
        this._utilClassToggle(e.target, "id-current");
        this.ap_pattern_id = parseInt(e.target.getAttribute("data-value"));
        this.apUpdate();
      };
      this.apUpdate = () => {
        this.arpeggio = this.AP.patterns[this.ap_pattern_type][
          this.ap_pattern_id
        ];
      };
      this.apUpdate();
    }
  
    _utilClassToggle(el, classname) {
      let curr = document.querySelectorAll("." + classname);
      for (let i = 0; i < curr.length; i++) curr[i].classList.remove(classname);
      el.classList.add(classname);
    }
  
    /**  
    utilActiveNoteClassToggle
    removes all classnames on existing, then adds to an array of note classes
    @param note_classes {Array} [A3, B4]
    @param classname {String} 'active-treble'
   */
    _utilActiveNoteClassToggle = (note_classes, classname) => {
      let removals = document.querySelectorAll(`.${classname}`);
      for (let r = 0; r < removals.length; r++)
        removals[r].classList.remove(classname);
      let adds = document.querySelectorAll(
        note_classes
          .map((n) => {
            return `.${n}`;
          })
          .join(", ")
      );
      for (let a = 0; a < adds.length; a++) adds[a].classList.add(classname);
    };
  }
  
  let pianoplayer = new ArpPlayer();
  
  
  
  
}

piano_player();
