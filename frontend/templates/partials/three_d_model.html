
<a-scene 
    vr-mode-ui="enabled: false"
    embedded 
    style="width: 100%; height: 100%;"
    shadow="type: pcfsoft"
>

    <a-assets>
      <a-asset-item id="pub1" src="/media/vox_files/models/pub/pub.gltf"></a-asset-item>

<a-asset-item id="otherprop1" src="/media/vox_files/models/other_prop_01/other_prop_01.gltf"></a-asset-item>
<a-asset-item id="otherprop2" src="/media/vox_files/models/other_prop_02/other_prop_02.gltf"></a-asset-item>
<a-asset-item id="otherprop3" src="/media/vox_files/models/other_prop_03/other_prop_03.gltf"></a-asset-item>
<a-asset-item id="otherprop4" src="/media/vox_files/models/other_prop_04/other_prop_04.gltf"></a-asset-item>

      <a-asset-item id="tree1" src="/media/vox_files/models/trees/trees.gltf"></a-asset-item>
      <a-asset-item id="pavement1" src="/media/vox_files/models/pavement/pavement.gltf"></a-asset-item>

      <a-asset-item id="road1" src="/media/vox_files/models/road/road.gltf"></a-asset-item>

      <a-asset-item id="cloud1" src="/media/vox_files/models/clouds/clouds.gltf"></a-asset-item>

      <a-asset-item id="sky1" src="/media/vox_files/models/sky/day.gltf"></a-asset-item>

      <img id="boxTexture" src="/media/vox_files/models/pub/tex/LINED_PAPER.jpg">
    </a-assets>

    <a-entity light="type: ambient; intensity: 0.3;"></a-entity>

    <a-entity 
      id="cloudLight"
      light="type: directional;castShadow: true;intensity: 0.9;"
      position="-20 50 80"
    >
    </a-entity>

    <a-entity 
      id="groundLight"
      light="type: directional;castShadow: true;intensity: 0.9;"
      position="-5 50 100"
    >
    </a-entity>

      <a-entity id="treesContainer" shadow="cast: true; receive: true;"></a-entity> 

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var container = document.getElementById('treesContainer');
          // #pub1 is at (-50, 0, 0), so place trees in front (higher z)
          // We'll run them along the x-axis, in front of the model (z = 20)
          var treePositions = [
            {x: -140, y: 0, z: 105},
            {x: -80, y: 0, z: 105},
            {x: -20, y: 0, z: 105},
            {x: 40, y: 0, z: 105},
            {x: 100, y: 0, z: 105},
            {x: 160, y: 0, z: 105},
                        {x: -140, y: 0, z: 195},
            {x: -80, y: 0, z: 195},
            {x: -20, y: 0, z: 195},
            {x: 40, y: 0, z: 195},
            {x: 100, y: 0, z: 195},
            {x: 160, y: 0, z: 195},
          ];
          for (var i = 0; i < treePositions.length; i++) {
            var pos = treePositions[i];
            var scale = (Math.random() * 0.4 + 0.4).toFixed(1); // random scale 0.5-2.0
            var tree = document.createElement('a-entity');
            var tree_id = 'tree' + (i + 1);
            tree.setAttribute('gltf-model', '#tree1');
            tree.setAttribute('id', tree_id);
            tree.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
            tree.setAttribute('scale', `${scale} ${scale} ${scale}`);
            container.appendChild(tree);
          }
        });
      </script>

      <a-entity id="cloudsContainer" shadow="cast: true; receive: true;"></a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var container = document.getElementById('cloudsContainer');
          var cloudIndex = 0;
          var cloudSpeed = 0.2; // units per frame
          var cloudInterval = 2000; // ms between new clouds
          const MAX_CLOUDS = 19; // Set your desired maximum

            // Function to create a new cloud
          function addCloud() {
            if (container.children.length >= MAX_CLOUDS) {
              container.removeChild(container.children[0]); // Remove oldest cloud
            }
            var x = -200;
            var y = Math.random() * 60 + 100;
            var z = Math.random() * 10 + 60;
            var scale = (Math.random() * 0.2 + 0.5).toFixed(1);
            var cloud = document.createElement('a-entity');
            cloud.setAttribute('gltf-model', '#cloud1');
            cloud.setAttribute('id', 'cloudStream' + cloudIndex++);
            cloud.setAttribute('position', `${x} ${y} ${z}`);
            cloud.setAttribute('scale', `${scale} ${scale} ${scale}`);
            container.appendChild(cloud);
          }
          // Move clouds every frame
          function animateClouds() {
            var clouds = container.children;
            for (var i = clouds.length - 1; i >= 0; i--) {
              var cloud = clouds[i];

              if (cloud) {
                cloud.setAttribute('shadow', 'cast: true; receive: true;');
                cloud.addEventListener('model-loaded', function(e) {
                  var mesh = e.detail.model;
                  mesh.traverse(function(node) {
                    if (node.isMesh) {
                      node.castShadow = true;
                      node.receiveShadow = true;
                    }
                  });
                });
              }

              var pos = cloud.getAttribute('position');
              if (pos) {
                var newX = pos.x + cloudSpeed;
                cloud.setAttribute('position', `${newX} ${pos.y} ${pos.z}`);
                // Remove cloud if out of view
                if (newX > 200) {
                  container.removeChild(cloud);
                }
              }
            }
            requestAnimationFrame(animateClouds);
          }




          // Start the stream
          setInterval(addCloud, cloudInterval);
          animateClouds();
        });
      </script>

      <a-entity
        id="pubModel" 
        gltf-model="#pub1"
        animation-mixer
        scale="1 1 1"
        rotation="0 0 0"
        position="-50 0 0"
        shadow="cast: true; receive: true;"
      >
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var model = document.getElementById('pubModel');
          if (model) {
            model.setAttribute('shadow', 'cast: true; receive: true;');
            model.addEventListener('model-loaded', function(e) {
              var mesh = e.detail.model;
              mesh.traverse(function(node) {
                if (node.isMesh) {
                  node.castShadow = true;
                  node.receiveShadow = true;
                }
              });
            });
          }
        });
      </script>

      <a-entity
        id="otherProp1" 
        gltf-model="#otherprop1"
        animation-mixer
        scale="1 1 1"
        rotation="0 0 0"
        position="80 0 -10"
        shadow="cast: true; receive: true;"
      >
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var model = document.getElementById('otherProp1');
          if (model) {
            model.setAttribute('shadow', 'cast: true; receive: true;');
            model.addEventListener('model-loaded', function(e) {
              var mesh = e.detail.model;
              mesh.traverse(function(node) {
                if (node.isMesh) {
                  node.castShadow = true;
                  node.receiveShadow = true;
                }
              });
            });
          }
        });
      </script>

      <a-entity
        id="otherProp2" 
        gltf-model="#otherprop2"
        animation-mixer
        scale="1 1 1"
        rotation="0 0 0"
        position="-150 0 -10"
        shadow="cast: true; receive: true;"
      >
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var model = document.getElementById('otherProp2');
          if (model) {
            model.setAttribute('shadow', 'cast: true; receive: true;');
            model.addEventListener('model-loaded', function(e) {
              var mesh = e.detail.model;
              mesh.traverse(function(node) {
                if (node.isMesh) {
                  node.castShadow = true;
                  node.receiveShadow = true;
                }
              });
            });
          }
        });
      </script>

      <a-entity
        id="otherProp3" 
        gltf-model="#otherprop3"
        animation-mixer
        scale="1 1 1"
        rotation="0 0 0"
        position="225 0 -30
        shadow="cast: true; receive: true;"
      >
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var model = document.getElementById('otherProp3');
          if (model) {
            model.setAttribute('shadow', 'cast: true; receive: true;');
            model.addEventListener('model-loaded', function(e) {
              var mesh = e.detail.model;
              mesh.traverse(function(node) {
                if (node.isMesh) {
                  node.castShadow = true;
                  node.receiveShadow = true;
                }
              });
            });
          }
        });
      </script>

      <a-entity
        id="otherProp4" 
        gltf-model="#otherprop4"
        animation-mixer
        scale="1 1 1"
        rotation="0 0 0"
        position="-300 0 -60
        shadow="cast: true; receive: true;"
      >
      </a-entity>

      <script>
        document.addEventListener('DOMContentLoaded', function() {
          var model = document.getElementById('otherProp4');
          if (model) {
            model.setAttribute('shadow', 'cast: true; receive: true;');
            model.addEventListener('model-loaded', function(e) {
              var mesh = e.detail.model;
              mesh.traverse(function(node) {
                if (node.isMesh) {
                  node.castShadow = true;
                  node.receiveShadow = true;
                }
              });
            });
          }
        });
      </script>

      <a-entity 
        id="pavement1"
        gltf-model="#pavement1" 
        position="0 0 -20" 
        shadow="cast: true; receive: true;"
        rotation="0 0 0"
        scale="2 1 1"
      >
      </a-entity>

      <a-entity 
        id="pavement2"
        gltf-model="#pavement1" 
        position="0 0 -80" 
        shadow="cast: true; receive: true;"
        rotation="0 0 0"
        scale="2 1 1"
      >
      </a-entity>

      <a-entity 
        id="pavement3"
        gltf-model="#pavement1" 
        position="0 0 100" 
        shadow="cast: true; receive: true;"
        rotation="0 0 0"
      >
      </a-entity>

      <a-entity 
        id="road1"
        gltf-model="#road1" 
        position="0 -8 160" 
        shadow="cast: true; receive: true;"
        rotation="0 90 0"
        scale="2 1 1.5"
      >
      </a-entity>

      <a-entity 
        id="sky1"
        gltf-model="#sky1" 
        position="0 0 -750" 
        shadow="cast: true; receive: true;"
        rotation="0 -90 0"
      >
      </a-entity>

      <a-entity id="rig" position="-100 -20 250" rotation="0 0 0">
          <a-entity 
              id="isoCamera" 
              camera 
              position="100 50 0"
              rotation="0 100 0"
              fov="70"
              far="10000"
              look-controls="enabled: true;"
    limited-look-controls="minPitch: -10; maxPitch: 10; minYaw: -10; maxYaw: 10"
    shadow="cast: true; receive: true;"
          >
          </a-entity>
      </a-entity>

      <script>
        AFRAME.registerComponent('limited-look-controls', {
          schema: {
            minPitch: {default: -10}, // degrees
            maxPitch: {default: 10},
            minYaw: {default: -10},
            maxYaw: {default: 10}
          },
          tick: function () {
            var rotation = this.el.getAttribute('rotation');
            // Clamp pitch (x) and yaw (y)
            rotation.x = Math.max(this.data.minPitch, Math.min(this.data.maxPitch, rotation.x));
            rotation.y = Math.max(this.data.minYaw, Math.min(this.data.maxYaw, rotation.y));
            this.el.setAttribute('rotation', rotation);
          }
        });
      </script>

</a-scene>